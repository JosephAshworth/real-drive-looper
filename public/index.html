<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Drive API Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body {
      background: #111; color: #fff; text-align: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem; margin: 0;
    }
    input[type="text"] {
      width: min(780px, 90%);
      padding: 0.6rem 0.8rem; font-size: 1rem;
      border-radius: 8px; border: none; outline: none;
      background:#1a1a1a; color:#fff;
    }
    .row { margin-top: 1rem; }
    .btn {
      padding: 0.6rem 1rem; margin: 0.25rem;
      background: #1db954; border: none; border-radius: 8px;
      cursor: pointer; font-weight: 600; color:#08130a;
    }
    .btn:hover { background:#17a84a; }
    #loader { display:none; margin-top: 0.75rem; }
    #error { color:#ff6b6b; margin-top: 0.75rem; min-height: 1.25rem; }
    #videoContainer {
      width: 90%; max-width: 1200px; aspect-ratio: 16 / 9;
      background: #000; margin: 1.5rem auto 0; border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    video {
      width: 100%; height: 100%; object-fit: contain;
      background:#000; border-radius: 12px;
    }
    .time-grid { display:inline-grid; grid-template-columns: repeat(8, max-content); gap: 6px 8px; align-items: center; }
    .time-grid input { width: 72px; padding: 0.35rem 0.5rem; border-radius: 6px; border: none; background:#1a1a1a; color:#fff; }
    .sep { opacity: 0.6; }
    small.hint { display:block; opacity:0.7; margin-top:0.5rem; }
  </style>
</head>
<body>
  <h1>üé• Google Drive API Video Player + Trimmer</h1>
  <input id="driveLink" placeholder="Paste Google Drive video link here">
  <button onclick="loadVideo()">Play</button>

  <div style="margin-top:1rem;">
    <label>Start Time:</label><br>
    <input type="number" id="startHours"   min="0" max="23" value="0" style="width:60px;"> :
    <input type="number" id="startMinutes" min="0" max="59" value="0" style="width:60px;"> :
    <input type="number" id="startSeconds" min="0" max="59" value="0" style="width:60px;"> .
    <input type="number" id="startMillis"  min="0" max="999" value="0" style="width:80px;" placeholder="ms">

    <br><br>
    <label>End Time:</label><br>
    <input type="number" id="endHours"   min="0" max="23" value="0" style="width:60px;"> :
    <input type="number" id="endMinutes" min="0" max="59" value="0" style="width:60px;"> :
    <input type="number" id="endSeconds" min="0" max="59" value="0" style="width:60px;"> .
    <input type="number" id="endMillis"  min="0" max="999" value="0" style="width:80px;" placeholder="ms">

  
    <br><br>
    <button onclick="previewTrim()">Preview Trim</button>
    <button onclick="downloadTrim()">Download Trim</button>
  </div>

  <div class="row">
    <div class="time-grid">
      <label for="startHours">Start</label>
      <input type="number" id="startHours"   min="0" max="23" value="0"> <span class="sep">:</span>
      <input type="number" id="startMinutes" min="0" max="59" value="0"> <span class="sep">:</span>
      <input type="number" id="startSeconds" min="0" max="59" value="0"> <span class="sep">.</span>
      <input type="number" id="startMillis"  min="0" max="999" value="0">

      <label for="endHours" style="margin-left:12px;">End</label>
      <input type="number" id="endHours"   min="0" max="23" value="0"> <span class="sep">:</span>
      <input type="number" id="endMinutes" min="0" max="59" value="0"> <span class="sep">:</span>
      <input type="number" id="endSeconds" min="0" max="59" value="0"> <span class="sep">.</span>
      <input type="number" id="endMillis"  min="0" max="999" value="0">
    </div>

    <div class="row">
      <button class="btn" id="previewBtn">Preview Trim</button>
      <button class="btn" id="downloadBtn">Download Trim</button>
      <small class="hint">Tip: whole seconds ‚Üí fastest preview; milliseconds ‚Üí precise re-encode.</small>
    </div>
  </div>

  <div id="loader">‚è≥ Working‚Ä¶</div>
  <div id="error"></div>
  <div id="videoContainer"></div>

  <script>
    // ---- Globals / state ----
    const noSleep = new NoSleep();
    let noSleepEnabled = false;
    let currentFileId = null;
    let currentVideoEl = null;
    let currentObjectUrl = null;
    let previewAbort = null;

    // ---- Helpers ----
    function extractFileId(url) {
      try {
        const patterns = [
          /\/d\/([a-zA-Z0-9_-]{25,})/,
          /id=([a-zA-Z0-9_-]{25,})/,
          /uc\?id=([a-zA-Z0-9_-]{25,})/,
        ];
        for (const p of patterns) {
          const m = url.match(p);
          if (m) return m[1];
        }
        // if they pasted a raw fileId
        if (/^[A-Za-z0-9_-]{20,}$/.test(url)) return url;
        return null;
      } catch {
        return null;
      }
    }

    function getOrSetFileIdFromInput() {
      if (currentFileId) return currentFileId;
      const link = document.getElementById("driveLink").value.trim();
      const fid = extractFileId(link);
      if (!fid) throw new Error("Invalid Google Drive link.");
      currentFileId = fid;
      return fid;
    }



    async function loadVideo() {
      setError("");
      cancelInFlight();

      const id = getFileIdFromInput();
      if (!id) { setError("‚ö†Ô∏è Paste a Google Drive link or file ID first."); return; }

      // HEAD check
      setLoader(true);
      try {
        const metaRes = await fetch(`/video/${id}`, { method: "HEAD", cache: "no-store" });
        if (!metaRes.ok) throw new Error("Video not accessible");
      } catch (e) {
        loader.style.display = "none";
        error.textContent = "‚ùå " + e.message;
      }
    }

    function sanitizeInput(id, max) {
      const el = document.getElementById(id);
      let val = parseInt(el.value, 10);
      if (isNaN(val) || val < 0) val = 0;
      if (val > max) val = max;
      el.value = val; // ‚úÖ always correct visually too
      return val;
    }

    function timeMsFromInputs(prefix) {
      const h  = sanitizeInput(prefix + "Hours", 23);
      const m  = sanitizeInput(prefix + "Minutes", 59);
      const s  = sanitizeInput(prefix + "Seconds", 59);
      const ms = sanitizeInput(prefix + "Millis", 999);
      return h * 3600000 + m * 60000 + s * 1000 + ms;
    }


    async function previewTrim() {
      const error = document.getElementById("error");
      error.textContent = "";

      // üîÅ Always extract a fresh fileId from the input (ignore any previous currentFileId)
      const link = document.getElementById("driveLink").value.trim();
      const fileId = extractFileId(link);
      if (!fileId) {
        error.textContent = "‚ö†Ô∏è Invalid Google Drive link.";
        return;
      }
      currentFileId = fileId; // keep in sync for Play/download

      const startMs = timeMsFromInputs("start");
      const endMs   = timeMsFromInputs("end");

      if (endMs <= startMs) {
        error.textContent = "‚ö†Ô∏è End time must be after start time.";
        return;
      }

      const container = document.getElementById("videoContainer");
      container.innerHTML = "‚è≥ Trimming preview...";

      try {
        const res = await fetch("/trim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fileId, startMs, endMs, preview: true })
        });

        setLoader(false);
        if (!res.ok) throw new Error("Trim failed");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        container.innerHTML = `
          <video controls autoplay style="width:100%;border-radius:10px;">
            <source src="${url}" type="video/mp4">
          </video>
        `;
        error.textContent = "";
      } catch (err) {
        if (err?.name === "AbortError") return; // canceled by us‚Äîignore
        setLoader(false);
        setError("‚ùå " + err.message);
      }
    }




    function downloadTrim() {
      const error = document.getElementById("error");
      error.textContent = "";

      // always extract a fresh fileId from the input (avoid stale currentFileId)
      const link = document.getElementById("driveLink").value.trim();
      const fileId = extractFileId(link);
      if (!fileId) {
        error.textContent = "‚ö†Ô∏è Invalid Google Drive link.";
        return;
      }
      currentFileId = fileId; // keep in sync with Play

      const startMs = timeMsFromInputs("start");
      const endMs   = timeMsFromInputs("end");

      if (endMs <= startMs) {
        error.textContent = "‚ö†Ô∏è End time must be after start time.";
        return;
      }

      const u = new URLSearchParams({ fileId, startMs: String(startMs), endMs: String(endMs) });
      window.location.href = `/trim?${u.toString()}`;
    }






    // üîß Auto-correct time inputs live as the user types
    function clampValue(input, max) {
      let val = parseInt(input.value, 10);
      if (isNaN(val) || val < 0) val = 0;
      if (val > max) val = max;
      input.value = val;
    }

    // Apply live clamping to all hour/min/sec inputs
    ["startHours","startMinutes","startSeconds","startMillis",
    "endHours","endMinutes","endSeconds","endMillis"].forEach(id => {
      const el = document.getElementById(id);
      const max = id.includes("Hours") ? 23 : id.includes("Millis") ? 999 : 59;
      el.addEventListener("input", () => clampValue(el, max));
    });




  </script>
</body>
</html>
